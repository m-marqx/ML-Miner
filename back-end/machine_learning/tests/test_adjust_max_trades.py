import unittest
import pandas as pd
import numpy as np
from machine_learning.model_builder import adjust_max_trades


class TestAdjustMaxTrades(unittest.TestCase):
    def setUp(self):
        self.rng = np.random.default_rng(33)
        size = 20
        self.data_set = pd.DataFrame(
            {
                "Predict": self.rng.integers(-1, 2, size),
                "y_pred_probs": self.rng.random(size),
                "Liquid_Result": (
                    self.rng.random(size) / 10 + self.rng.choice([-1, 1], size)
                ),
            }
        )
        self.off_days = 2
        self.max_trades = 3
        self.pct_adj = 0.5

    def test_adjust_max_trades_side_long(self):
        result = adjust_max_trades(
            self.data_set,
            self.off_days,
            self.max_trades,
            self.pct_adj,
            1,
        )

        expected_result = pd.DataFrame(
            {
                "Predict": {
                    0: 1,
                    1: 0,
                    2: 0,
                    3: 0,
                    4: 1,
                    5: 1,
                    6: 0,
                    7: 0,
                    8: 0,
                    9: 0,
                    10: 0,
                    11: 0,
                    12: 1,
                    13: 1,
                    14: 1,
                    15: 0,
                    16: 0,
                    17: 0,
                    18: 1,
                    19: 0,
                },
                "y_pred_probs": {
                    0: 0.24205589164409225,
                    1: 0.0,
                    2: 0.0,
                    3: 0.0,
                    4: 0.015436335029296422,
                    5: 0.7726223186926501,
                    6: 0.0,
                    7: 0.0,
                    8: 0.0,
                    9: 0.0,
                    10: 0.0,
                    11: 0.0,
                    12: 0.940111966487205,
                    13: 0.29677757425767115,
                    14: 0.9322303599288776,
                    15: 0.0,
                    16: 0.0,
                    17: 0.0,
                    18: 0.24754284677469984,
                    19: 0.0,
                },
                "Liquid_Result": {
                    0: 1.3609752615796253,
                    1: 1.0,
                    2: 1.0,
                    3: 1.0,
                    4: 1.3512565368958251,
                    5: 1.3570614738774132,
                    6: 1.0,
                    7: 1.0,
                    8: 1.0,
                    9: 1.0,
                    10: 1.0,
                    11: 1.0,
                    12: 0.6730855630791375,
                    13: 0.6992668794085519,
                    14: 0.6846133009880233,
                    15: 1.0,
                    16: 1.0,
                    17: 1.0,
                    18: 1.3362448220882923,
                    19: 1.0,
                },
                "Position": {
                    0: 0.0,
                    1: 1.0,
                    2: 0.0,
                    3: 0.0,
                    4: 0.0,
                    5: 1.0,
                    6: 1.0,
                    7: 0.0,
                    8: 0.0,
                    9: 0.0,
                    10: 0.0,
                    11: 0.0,
                    12: 0.0,
                    13: 1.0,
                    14: 1.0,
                    15: 1.0,
                    16: 0.0,
                    17: 0.0,
                    18: 0.0,
                    19: 1.0,
                },
                "Liquid_Result_pct_adj": {
                    0: 1.1804876307898127,
                    1: 1.0,
                    2: 1.0,
                    3: 1.0,
                    4: 1.1756282684479127,
                    5: 1.1785307369387066,
                    6: 1.0,
                    7: 1.0,
                    8: 1.0,
                    9: 1.0,
                    10: 1.0,
                    11: 1.0,
                    12: 0.8365427815395687,
                    13: 0.849633439704276,
                    14: 0.8423066504940117,
                    15: 1.0,
                    16: 1.0,
                    17: 1.0,
                    18: 1.1681224110441462,
                    19: 1.0,
                },
                "Liquid_Return": {
                    0: 1.3609752615796253,
                    1: 1.3609752615796253,
                    2: 1.3609752615796253,
                    3: 1.3609752615796253,
                    4: 1.8390267187629743,
                    5: 2.495672309464425,
                    6: 2.495672309464425,
                    7: 2.495672309464425,
                    8: 2.495672309464425,
                    9: 2.495672309464425,
                    10: 2.495672309464425,
                    11: 2.495672309464425,
                    12: 1.679801001676874,
                    13: 1.1746292044699473,
                    14: 0.8041667771091064,
                    15: 0.8041667771091064,
                    16: 0.8041667771091064,
                    17: 0.8041667771091064,
                    18: 1.0745636920074733,
                    19: 1.0745636920074733,
                },
                "Liquid_Return_simple": {
                    0: 0.36097526157962534,
                    1: 0.36097526157962534,
                    2: 0.36097526157962534,
                    3: 0.36097526157962534,
                    4: 0.7122317984754505,
                    5: 1.0692932723528636,
                    6: 1.0692932723528636,
                    7: 1.0692932723528636,
                    8: 1.0692932723528636,
                    9: 1.0692932723528636,
                    10: 1.0692932723528636,
                    11: 1.0692932723528636,
                    12: 0.7423788354320011,
                    13: 0.44164571484055304,
                    14: 0.12625901582857635,
                    15: 0.12625901582857635,
                    16: 0.12625901582857635,
                    17: 0.12625901582857635,
                    18: 0.46250383791686867,
                    19: 0.46250383791686867,
                },
                "Liquid_Return_pct_adj": {
                    0: 1.1804876307898127,
                    1: 1.1804876307898127,
                    2: 1.1804876307898127,
                    3: 1.1804876307898127,
                    4: 1.3878146293096063,
                    5: 1.6355821978145682,
                    6: 1.6355821978145682,
                    7: 1.6355821978145682,
                    8: 1.6355821978145682,
                    9: 1.6355821978145682,
                    10: 1.6355821978145682,
                    11: 1.6355821978145682,
                    12: 1.3682344811964,
                    13: 1.1624977685808928,
                    14: 0.9791796016601345,
                    15: 0.9791796016601345,
                    16: 0.9791796016601345,
                    17: 0.9791796016601345,
                    18: 1.143801637136483,
                    19: 1.143801637136483,
                },
                "Drawdown": {
                    0: 0.0,
                    1: 0.0,
                    2: 0.0,
                    3: 0.0,
                    4: 0.0,
                    5: 0.0,
                    6: 0.0,
                    7: 0.0,
                    8: 0.0,
                    9: 0.0,
                    10: 0.0,
                    11: 0.0,
                    12: 0.32691443692086253,
                    13: 0.5293335587307035,
                    14: 0.6777754939783414,
                    15: 0.6777754939783414,
                    16: 0.6777754939783414,
                    17: 0.6777754939783414,
                    18: 0.5694291722786009,
                    19: 0.5694291722786009,
                },
                "Drawdown_pct_adj": {
                    0: 0.0,
                    1: 0.0,
                    2: 0.0,
                    3: 0.0,
                    4: 0.0,
                    5: 0.0,
                    6: 0.0,
                    7: 0.0,
                    8: 0.0,
                    9: 0.0,
                    10: 0.0,
                    11: 0.0,
                    12: 0.16345721846043126,
                    13: 0.2892452790607535,
                    14: 0.40132657168285735,
                    15: 0.40132657168285735,
                    16: 0.40132657168285735,
                    17: 0.40132657168285735,
                    18: 0.3006761514861145,
                    19: 0.3006761514861145,
                },
            }
        )

        pd.testing.assert_frame_equal(result, expected_result)

    def test_adjust_max_trades_side_short(self):
        result = adjust_max_trades(
            self.data_set,
            self.off_days,
            self.max_trades,
            self.pct_adj,
            -1,
        )

        expected_result = pd.DataFrame(
            {
                "Predict": {
                    0: 0,
                    1: 0,
                    2: 0,
                    3: 0,
                    4: 0,
                    5: 0,
                    6: -1,
                    7: -1,
                    8: 0,
                    9: 0,
                    10: -1,
                    11: 0,
                    12: 0,
                    13: 0,
                    14: 0,
                    15: 0,
                    16: 0,
                    17: -1,
                    18: 0,
                    19: 0,
                },
                "y_pred_probs": {
                    0: 0.0,
                    1: 0.0,
                    2: 0.0,
                    3: 0.0,
                    4: 0.0,
                    5: 0.0,
                    6: 0.803641956335516,
                    7: 0.02059809225038467,
                    8: 0.0,
                    9: 0.0,
                    10: 0.4011394081519617,
                    11: 0.0,
                    12: 0.0,
                    13: 0.0,
                    14: 0.0,
                    15: 0.0,
                    16: 0.0,
                    17: 0.2511168633248656,
                    18: 0.0,
                    19: 0.0,
                },
                "Liquid_Result": {
                    0: 1.0,
                    1: 1.0,
                    2: 1.0,
                    3: 1.0,
                    4: 1.0,
                    5: 1.0,
                    6: 0.6902220023935262,
                    7: 0.6947476115959323,
                    8: 1.0,
                    9: 1.0,
                    10: 1.3564235029250418,
                    11: 1.0,
                    12: 1.0,
                    13: 1.0,
                    14: 1.0,
                    15: 1.0,
                    16: 1.0,
                    17: 0.6902677508879975,
                    18: 1.0,
                    19: 1.0,
                },
                "Position": {
                    0: 0.0,
                    1: 0.0,
                    2: 0.0,
                    3: 0.0,
                    4: 0.0,
                    5: 0.0,
                    6: 0.0,
                    7: -1.0,
                    8: -1.0,
                    9: 0.0,
                    10: 0.0,
                    11: -1.0,
                    12: 0.0,
                    13: 0.0,
                    14: 0.0,
                    15: 0.0,
                    16: 0.0,
                    17: 0.0,
                    18: -1.0,
                    19: 0.0,
                },
                "Liquid_Result_pct_adj": {
                    0: 1.0,
                    1: 1.0,
                    2: 1.0,
                    3: 1.0,
                    4: 1.0,
                    5: 1.0,
                    6: 0.8451110011967631,
                    7: 0.8473738057979662,
                    8: 1.0,
                    9: 1.0,
                    10: 1.1782117514625208,
                    11: 1.0,
                    12: 1.0,
                    13: 1.0,
                    14: 1.0,
                    15: 1.0,
                    16: 1.0,
                    17: 0.8451338754439988,
                    18: 1.0,
                    19: 1.0,
                },
                "Liquid_Return": {
                    0: 1.0,
                    1: 1.0,
                    2: 1.0,
                    3: 1.0,
                    4: 1.0,
                    5: 1.0,
                    6: 0.6902220023935262,
                    7: 0.4795300876338642,
                    8: 0.4795300876338642,
                    9: 0.4795300876338642,
                    10: 0.6504458812262783,
                    11: 0.6504458812262783,
                    12: 0.6504458812262783,
                    13: 0.6504458812262783,
                    14: 0.6504458812262783,
                    15: 0.6504458812262783,
                    16: 0.6504458812262783,
                    17: 0.4489818155084247,
                    18: 0.4489818155084247,
                    19: 0.4489818155084247,
                },
                "Liquid_Return_simple": {
                    0: 0.0,
                    1: 0.0,
                    2: 0.0,
                    3: 0.0,
                    4: 0.0,
                    5: 0.0,
                    6: -0.30977799760647384,
                    7: -0.6150303860105415,
                    8: -0.6150303860105415,
                    9: -0.6150303860105415,
                    10: -0.25860688308549973,
                    11: -0.25860688308549973,
                    12: -0.25860688308549973,
                    13: -0.25860688308549973,
                    14: -0.25860688308549973,
                    15: -0.25860688308549973,
                    16: -0.25860688308549973,
                    17: -0.5683391321975022,
                    18: -0.5683391321975022,
                    19: -0.5683391321975022,
                },
                "Liquid_Return_pct_adj": {
                    0: 1.0,
                    1: 1.0,
                    2: 1.0,
                    3: 1.0,
                    4: 1.0,
                    5: 1.0,
                    6: 0.8451110011967631,
                    7: 0.7161249254058307,
                    8: 0.7161249254058307,
                    9: 0.7161249254058307,
                    10: 0.8437468026283709,
                    11: 0.8437468026283709,
                    12: 0.8437468026283709,
                    13: 0.8437468026283709,
                    14: 0.8437468026283709,
                    15: 0.8437468026283709,
                    16: 0.8437468026283709,
                    17: 0.7130790051987977,
                    18: 0.7130790051987977,
                    19: 0.7130790051987977,
                },
                "Drawdown": {
                    0: 0.0,
                    1: 0.0,
                    2: 0.0,
                    3: 0.0,
                    4: 0.0,
                    5: 0.0,
                    6: 0.30977799760647384,
                    7: 0.5204699123661358,
                    8: 0.5204699123661358,
                    9: 0.5204699123661358,
                    10: 0.34955411877372167,
                    11: 0.34955411877372167,
                    12: 0.34955411877372167,
                    13: 0.34955411877372167,
                    14: 0.34955411877372167,
                    15: 0.34955411877372167,
                    16: 0.34955411877372167,
                    17: 0.5510181844915754,
                    18: 0.5510181844915754,
                    19: 0.5510181844915754,
                },
                "Drawdown_pct_adj": {
                    0: 0.0,
                    1: 0.0,
                    2: 0.0,
                    3: 0.0,
                    4: 0.0,
                    5: 0.0,
                    6: 0.15488899880323692,
                    7: 0.2838750745941693,
                    8: 0.2838750745941693,
                    9: 0.2838750745941693,
                    10: 0.15625319737162913,
                    11: 0.15625319737162913,
                    12: 0.15625319737162913,
                    13: 0.15625319737162913,
                    14: 0.15625319737162913,
                    15: 0.15625319737162913,
                    16: 0.15625319737162913,
                    17: 0.28692099480120226,
                    18: 0.28692099480120226,
                    19: 0.28692099480120226,
                },
            }
        )

        pd.testing.assert_frame_equal(result, expected_result)
